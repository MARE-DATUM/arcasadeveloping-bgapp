/**
 * DIAGN√ìSTICO DIRETO NO CONSOLE - BGAPP
 * Cole este c√≥digo no console do browser para diagn√≥stico imediato
 */

// Fun√ß√£o de diagn√≥stico imediato
async function diagnosticoBGAPP() {
    console.log('üîç INICIANDO DIAGN√ìSTICO BGAPP...\n');
    
    const results = {
        timestamp: new Date().toISOString(),
        services: {},
        scripts: {},
        globals: {},
        summary: {}
    };
    
    // 1. Testar servi√ßos cr√≠ticos
    const services = [
        { name: 'Admin API Health', url: 'http://localhost:8000/admin-api/health' },
        { name: 'Admin API Collections', url: 'http://localhost:8000/admin-api/collections' },
        { name: 'Admin API Services', url: 'http://localhost:8000/admin-api/services/status' },
        { name: 'Admin API Connectors', url: 'http://localhost:8000/admin-api/connectors' },
        { name: 'PyGeoAPI', url: 'http://localhost:5080/collections' },
        { name: 'Frontend', url: 'http://localhost:8085' }
    ];
    
    console.log('üîß TESTANDO SERVI√áOS...');
    
    for (const service of services) {
        const startTime = Date.now();
        try {
            const response = await fetch(service.url, { 
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            });
            
            const responseTime = Date.now() - startTime;
            const status = response.ok ? '‚úÖ' : '‚ùå';
            
            results.services[service.name] = {
                status: response.ok ? 'OK' : 'FAIL',
                httpStatus: response.status,
                responseTime: responseTime
            };
            
            console.log(`${status} ${service.name}: HTTP ${response.status} (${responseTime}ms)`);
            
        } catch (error) {
            const responseTime = Date.now() - startTime;
            results.services[service.name] = {
                status: 'ERROR',
                error: error.message,
                responseTime: responseTime
            };
            
            console.log(`‚ùå ${service.name}: ${error.message} (${responseTime}ms)`);
        }
    }
    
    // 2. Verificar scripts carregados
    console.log('\nüì¶ VERIFICANDO SCRIPTS...');
    
    const scripts = [
        'api-resilience.js',
        'api-plugin-manager.js', 
        'api-adapter.js',
        'health-checker.js'
    ];
    
    for (const script of scripts) {
        const scriptTag = document.querySelector(`script[src*="${script}"]`);
        const status = scriptTag ? '‚úÖ' : '‚ùå';
        
        results.scripts[script] = {
            loaded: !!scriptTag,
            src: scriptTag ? scriptTag.src : null
        };
        
        console.log(`${status} ${script}: ${scriptTag ? 'Carregado' : 'N√ÉO ENCONTRADO'}`);
    }
    
    // 3. Verificar vari√°veis globais
    console.log('\nüåê VERIFICANDO VARI√ÅVEIS GLOBAIS...');
    
    const globals = [
        { name: 'API', desc: 'Admin API original' },
        { name: 'apiResilienceManager', desc: 'Sistema de Resili√™ncia' },
        { name: 'apiPluginManager', desc: 'Gerenciador de Plugins' },
        { name: 'bgappAPIAdapter', desc: 'Adaptador de API' },
        { name: 'bgappHealthChecker', desc: 'Health Checker' }
    ];
    
    for (const global of globals) {
        const exists = !!window[global.name];
        const status = exists ? '‚úÖ' : '‚ùå';
        const type = exists ? typeof window[global.name] : 'undefined';
        
        results.globals[global.name] = {
            exists: exists,
            type: type,
            initialized: exists && window[global.name].initialized !== false
        };
        
        console.log(`${status} ${global.name} (${global.desc}): ${type}`);
        
        if (exists && window[global.name].initialized === false) {
            console.log(`   ‚ö†Ô∏è Existe mas n√£o foi inicializado`);
        }
    }
    
    // 4. Testar funcionalidades
    console.log('\n‚öôÔ∏è TESTANDO FUNCIONALIDADES...');
    
    // Testar API original
    if (window.API) {
        try {
            const methods = Object.keys(window.API);
            console.log(`‚úÖ API original: ${methods.length} m√©todos dispon√≠veis`);
            console.log(`   M√©todos: ${methods.slice(0, 5).join(', ')}${methods.length > 5 ? '...' : ''}`);
        } catch (error) {
            console.log(`‚ùå API original: Erro ao inspecionar - ${error.message}`);
        }
    }
    
    // Testar Plugin Manager
    if (window.apiPluginManager) {
        try {
            const pluginStatus = window.apiPluginManager.getPluginsStatus();
            const pluginCount = Object.keys(pluginStatus).length;
            console.log(`‚úÖ Plugin Manager: ${pluginCount} plugins registrados`);
            
            if (pluginCount > 0) {
                console.log('   Plugins:', Object.keys(pluginStatus).join(', '));
            }
        } catch (error) {
            console.log(`‚ùå Plugin Manager: Erro - ${error.message}`);
        }
    }
    
    // 5. Gerar resumo
    const serviceResults = Object.values(results.services);
    const okServices = serviceResults.filter(s => s.status === 'OK').length;
    const totalServices = serviceResults.length;
    
    const scriptResults = Object.values(results.scripts);
    const loadedScripts = scriptResults.filter(s => s.loaded).length;
    const totalScripts = scriptResults.length;
    
    const globalResults = Object.values(results.globals);
    const availableGlobals = globalResults.filter(g => g.exists).length;
    const totalGlobals = globalResults.length;
    
    results.summary = {
        services: `${okServices}/${totalServices}`,
        scripts: `${loadedScripts}/${totalScripts}`,
        globals: `${availableGlobals}/${totalGlobals}`,
        overall: okServices === totalServices && loadedScripts === totalScripts ? 'HEALTHY' : 'DEGRADED'
    };
    
    console.log('\nüìä RESUMO:');
    console.log(`   Servi√ßos: ${results.summary.services} funcionando`);
    console.log(`   Scripts: ${results.summary.scripts} carregados`);
    console.log(`   Globais: ${results.summary.globals} dispon√≠veis`);
    console.log(`   Status Geral: ${results.summary.overall}`);
    
    // 6. Recomenda√ß√µes
    console.log('\nüí° RECOMENDA√á√ïES:');
    
    if (results.services['Admin API Health']?.status !== 'OK') {
        console.log('üî¥ CR√çTICO: Iniciar admin_api_simple.py');
        console.log('   Comando: python admin_api_simple.py');
    }
    
    if (results.services['PyGeoAPI']?.status !== 'OK') {
        console.log('‚ö†Ô∏è Opcional: Iniciar PyGeoAPI');
        console.log('   Comando: docker-compose up pygeoapi');
    }
    
    if (results.scripts['health-checker.js']?.loaded === false) {
        console.log('üîß Recarregar p√°gina para carregar health-checker.js');
    }
    
    if (results.globals['apiPluginManager']?.exists === false) {
        console.log('üîß Sistema de plugins n√£o carregado - verificar console por erros');
    }
    
    // Salvar resultados globalmente
    window.diagnosticoResults = results;
    console.log('\nüíæ Resultados salvos em window.diagnosticoResults');
    
    console.log('\nüéâ DIAGN√ìSTICO COMPLETO!');
    return results;
}

// Fun√ß√£o para testar um endpoint espec√≠fico
async function testarEndpoint(url) {
    console.log(`üîç Testando: ${url}`);
    
    try {
        const startTime = Date.now();
        const response = await fetch(url);
        const responseTime = Date.now() - startTime;
        
        console.log(`${response.ok ? '‚úÖ' : '‚ùå'} HTTP ${response.status} (${responseTime}ms)`);
        
        if (response.ok) {
            try {
                const data = await response.json();
                console.log('üìÑ Resposta:', data);
            } catch (e) {
                console.log('üìÑ Resposta: (n√£o √© JSON)');
            }
        }
        
        return response;
        
    } catch (error) {
        console.log(`‚ùå Erro: ${error.message}`);
        return null;
    }
}

// Fun√ß√£o para for√ßar inicializa√ß√£o dos plugins
function forcarInicializacaoPlugins() {
    console.log('üîÑ For√ßando inicializa√ß√£o dos plugins...');
    
    if (window.apiResilienceManager) {
        window.apiResilienceManager.initialize();
        console.log('‚úÖ API Resilience Manager inicializado');
    }
    
    if (window.apiPluginManager) {
        window.apiPluginManager.initialize();
        console.log('‚úÖ API Plugin Manager inicializado');
    }
    
    if (window.bgappAPIAdapter) {
        window.bgappAPIAdapter.initialize();
        console.log('‚úÖ BGAPP API Adapter inicializado');
    }
    
    console.log('üéâ Inicializa√ß√£o for√ßada completa!');
}

// Fun√ß√£o para criar health checker se n√£o existir
function criarHealthChecker() {
    if (window.healthCheck) {
        console.log('‚úÖ healthCheck() j√° existe');
        return;
    }
    
    console.log('üîß Criando healthCheck() tempor√°rio...');
    
    window.healthCheck = diagnosticoBGAPP;
    window.quickCheck = () => {
        console.log('‚ö° Diagn√≥stico r√°pido...');
        return diagnosticoBGAPP();
    };
    window.testarEndpoint = testarEndpoint;
    window.forcarPlugins = forcarInicializacaoPlugins;
    
    console.log('‚úÖ Fun√ß√µes de diagn√≥stico criadas:');
    console.log('   - healthCheck()');
    console.log('   - quickCheck()');
    console.log('   - testarEndpoint(url)');
    console.log('   - forcarPlugins()');
}

// Auto-executar
console.log('üè• BGAPP Diagn√≥stico Console carregado!');
console.log('üìã Fun√ß√µes dispon√≠veis:');
console.log('   - diagnosticoBGAPP() - Diagn√≥stico completo');
console.log('   - testarEndpoint(url) - Testar endpoint espec√≠fico');
console.log('   - forcarInicializacaoPlugins() - For√ßar init plugins');
console.log('   - criarHealthChecker() - Criar fun√ß√µes se n√£o existirem');

// Criar health checker se n√£o existir
criarHealthChecker();

// Executar diagn√≥stico autom√°tico
setTimeout(() => {
    console.log('\nüöÄ EXECUTANDO DIAGN√ìSTICO AUTOM√ÅTICO...');
    diagnosticoBGAPP();
}, 1000);
