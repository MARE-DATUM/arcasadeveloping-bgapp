#!/usr/bin/env python3
"""
Script de teste para a API segura do BGAPP
Testa autentica√ß√£o JWT, rate limiting e endpoints protegidos
"""

import requests
import json
import time
from datetime import datetime
import sys

class BGAPPSecurityTester:
    def __init__(self, base_url="http://localhost:8000"):
        self.base_url = base_url
        self.access_token = None
        self.session = requests.Session()
    
    def print_section(self, title):
        """Imprimir se√ß√£o de teste"""
        print(f"\n{'='*60}")
        print(f"üß™ {title}")
        print('='*60)
    
    def test_health_endpoint(self):
        """Testar endpoint p√∫blico de health"""
        self.print_section("TESTE DO ENDPOINT P√öBLICO")
        
        try:
            response = self.session.get(f"{self.base_url}/health")
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ Health check: {data['status']}")
                print(f"   Vers√£o: {data.get('version', 'N/A')}")
                print(f"   Ambiente: {data.get('environment', 'N/A')}")
                return True
            else:
                print(f"‚ùå Health check falhou: {response.status_code}")
                return False
        except Exception as e:
            print(f"‚ùå Erro no health check: {e}")
            return False
    
    def test_authentication(self):
        """Testar sistema de autentica√ß√£o"""
        self.print_section("TESTE DE AUTENTICA√á√ÉO")
        
        # Teste 1: Login com credenciais v√°lidas
        print("üîê Testando login com credenciais v√°lidas...")
        
        login_data = {
            "username": "admin",
            "password": "bgapp123"
        }
        
        try:
            response = self.session.post(
                f"{self.base_url}/auth/login",
                data=login_data,
                headers={"Content-Type": "application/x-www-form-urlencoded"}
            )
            
            if response.status_code == 200:
                tokens = response.json()
                self.access_token = tokens["access_token"]
                print("‚úÖ Login bem-sucedido")
                print(f"   Token type: {tokens['token_type']}")
                print(f"   Access token: {self.access_token[:20]}...")
                
                # Configurar header de autoriza√ß√£o
                self.session.headers.update({
                    "Authorization": f"Bearer {self.access_token}"
                })
                
                return True
            else:
                print(f"‚ùå Login falhou: {response.status_code}")
                print(f"   Resposta: {response.text}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro no login: {e}")
            return False
    
    def test_invalid_credentials(self):
        """Testar credenciais inv√°lidas"""
        print("\nüîê Testando credenciais inv√°lidas...")
        
        invalid_data = {
            "username": "admin",
            "password": "wrong-password"
        }
        
        try:
            response = requests.post(
                f"{self.base_url}/auth/login",
                data=invalid_data,
                headers={"Content-Type": "application/x-www-form-urlencoded"}
            )
            
            if response.status_code == 401:
                print("‚úÖ Credenciais inv√°lidas rejeitadas corretamente")
                return True
            else:
                print(f"‚ùå Comportamento inesperado: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro no teste de credenciais inv√°lidas: {e}")
            return False
    
    def test_protected_endpoints(self):
        """Testar endpoints protegidos"""
        self.print_section("TESTE DE ENDPOINTS PROTEGIDOS")
        
        if not self.access_token:
            print("‚ùå Token de acesso necess√°rio")
            return False
        
        # Teste 1: Endpoint que requer autentica√ß√£o
        print("üîí Testando endpoint /services (requer autentica√ß√£o)...")
        
        try:
            response = self.session.get(f"{self.base_url}/services")
            
            if response.status_code == 200:
                services = response.json()
                print(f"‚úÖ Acesso autorizado - {len(services)} servi√ßos encontrados")
                for service in services[:3]:
                    print(f"   - {service['name']}: {service['status']}")
                return True
            else:
                print(f"‚ùå Acesso negado: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro no teste de endpoint protegido: {e}")
            return False
    
    def test_admin_endpoints(self):
        """Testar endpoints que requerem permiss√µes de admin"""
        self.print_section("TESTE DE ENDPOINTS ADMIN")
        
        if not self.access_token:
            print("‚ùå Token de acesso necess√°rio")
            return False
        
        print("üëë Testando endpoint admin /database/tables...")
        
        try:
            response = self.session.get(f"{self.base_url}/database/tables")
            
            if response.status_code == 200:
                tables = response.json()
                print(f"‚úÖ Acesso admin autorizado - {len(tables)} tabelas encontradas")
                for table in tables[:3]:
                    print(f"   - {table['schema']}.{table['name']}: {table['records']} registos")
                return True
            elif response.status_code == 403:
                print("‚úÖ Acesso negado corretamente (utilizador sem permiss√µes admin)")
                return True
            else:
                print(f"‚ùå Comportamento inesperado: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro no teste de endpoint admin: {e}")
            return False
    
    def test_unauthorized_access(self):
        """Testar acesso sem token"""
        self.print_section("TESTE DE ACESSO N√ÉO AUTORIZADO")
        
        print("üö´ Testando acesso sem token de autoriza√ß√£o...")
        
        # Criar sess√£o sem token
        unauthorized_session = requests.Session()
        
        try:
            response = unauthorized_session.get(f"{self.base_url}/services")
            
            if response.status_code == 401:
                print("‚úÖ Acesso n√£o autorizado rejeitado corretamente")
                return True
            else:
                print(f"‚ùå Endpoint deveria rejeitar acesso: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro no teste de acesso n√£o autorizado: {e}")
            return False
    
    def test_rate_limiting(self):
        """Testar rate limiting"""
        self.print_section("TESTE DE RATE LIMITING")
        
        print("‚è±Ô∏è Testando rate limiting (fazendo m√∫ltiplos requests)...")
        
        # Fazer m√∫ltiplos requests rapidamente
        rate_limit_session = requests.Session()
        success_count = 0
        rate_limited_count = 0
        
        for i in range(15):  # Fazer 15 requests
            try:
                response = rate_limit_session.get(f"{self.base_url}/health")
                
                if response.status_code == 200:
                    success_count += 1
                elif response.status_code == 429:
                    rate_limited_count += 1
                    print(f"‚úÖ Rate limit ativado no request {i+1}")
                    break
                
                time.sleep(0.1)  # Pequena pausa
                
            except Exception as e:
                print(f"‚ùå Erro no request {i+1}: {e}")
        
        print(f"üìä Resultado: {success_count} sucessos, {rate_limited_count} rate limited")
        
        if rate_limited_count > 0:
            print("‚úÖ Rate limiting funcionando")
            return True
        else:
            print("‚ö†Ô∏è Rate limiting pode estar desabilitado ou limite muito alto")
            return True  # N√£o √© erro cr√≠tico
    
    def test_sql_security(self):
        """Testar seguran√ßa SQL"""
        self.print_section("TESTE DE SEGURAN√áA SQL")
        
        if not self.access_token:
            print("‚ùå Token de acesso necess√°rio")
            return False
        
        print("üõ°Ô∏è Testando prote√ß√£o contra SQL injection...")
        
        # Tentar SQL injection
        malicious_queries = [
            "SELECT * FROM users; DROP TABLE users;--",
            "SELECT * FROM users WHERE id = 1 OR 1=1",
            "SELECT * FROM users UNION SELECT * FROM passwords",
            "INSERT INTO users VALUES ('hacker', 'password')"
        ]
        
        blocked_count = 0
        
        for query in malicious_queries:
            try:
                response = self.session.post(
                    f"{self.base_url}/database/query",
                    json={"sql": query}
                )
                
                if response.status_code == 400:
                    blocked_count += 1
                    print(f"‚úÖ Query maliciosa bloqueada: {query[:30]}...")
                else:
                    print(f"‚ùå Query maliciosa n√£o bloqueada: {response.status_code}")
                
            except Exception as e:
                print(f"‚ùå Erro no teste SQL: {e}")
        
        print(f"üìä {blocked_count}/{len(malicious_queries)} queries maliciosas bloqueadas")
        
        return blocked_count == len(malicious_queries)
    
    def test_user_info(self):
        """Testar endpoint de informa√ß√µes do utilizador"""
        print("\nüë§ Testando informa√ß√µes do utilizador...")
        
        if not self.access_token:
            print("‚ùå Token de acesso necess√°rio")
            return False
        
        try:
            response = self.session.get(f"{self.base_url}/auth/me")
            
            if response.status_code == 200:
                user_info = response.json()
                print("‚úÖ Informa√ß√µes do utilizador obtidas:")
                print(f"   Username: {user_info['username']}")
                print(f"   Role: {user_info['role']}")
                print(f"   Scopes: {', '.join(user_info['scopes'])}")
                return True
            else:
                print(f"‚ùå Erro ao obter informa√ß√µes: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro no teste de informa√ß√µes: {e}")
            return False
    
    def run_all_tests(self):
        """Executar todos os testes"""
        print("üöÄ BGAPP - TESTE DE SEGURAN√áA DAS APIs")
        print(f"üïê Iniciado em: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"üåê URL base: {self.base_url}")
        
        results = []
        
        # Executar testes
        results.append(("Health Check", self.test_health_endpoint()))
        results.append(("Autentica√ß√£o V√°lida", self.test_authentication()))
        results.append(("Credenciais Inv√°lidas", self.test_invalid_credentials()))
        results.append(("Informa√ß√µes do Utilizador", self.test_user_info()))
        results.append(("Endpoints Protegidos", self.test_protected_endpoints()))
        results.append(("Endpoints Admin", self.test_admin_endpoints()))
        results.append(("Acesso N√£o Autorizado", self.test_unauthorized_access()))
        results.append(("Rate Limiting", self.test_rate_limiting()))
        results.append(("Seguran√ßa SQL", self.test_sql_security()))
        
        # Relat√≥rio final
        self.print_section("RELAT√ìRIO FINAL")
        
        passed = sum(1 for _, result in results if result)
        total = len(results)
        
        print("üìã Resultados dos testes:")
        for test_name, result in results:
            status = "‚úÖ PASSOU" if result else "‚ùå FALHOU"
            print(f"   {test_name}: {status}")
        
        print(f"\nüìä Resumo: {passed}/{total} testes passaram")
        
        if passed == total:
            print("üéâ TODOS OS TESTES DE SEGURAN√áA PASSARAM!")
            return True
        else:
            print("‚ö†Ô∏è ALGUNS TESTES FALHARAM - VERIFICAR CONFIGURA√á√ÉO")
            return False

def main():
    """Fun√ß√£o principal"""
    
    # Permitir URL personalizada
    base_url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:8000"
    
    tester = BGAPPSecurityTester(base_url)
    success = tester.run_all_tests()
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
