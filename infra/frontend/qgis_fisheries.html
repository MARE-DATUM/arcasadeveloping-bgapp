<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QGIS - Infraestruturas Pesqueiras de Angola</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 320px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-control {
            margin-bottom: 15px;
        }

        .layer-control label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .layer-control label:hover {
            background: #e9ecef;
            border-color: #1e3c72;
        }

        .layer-control input[type="checkbox"] {
            margin: 0;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }

        .filter-section select,
        .filter-section input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .filter-section select:focus,
        .filter-section input:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 2px rgba(30, 60, 114, 0.1);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:hover {
            background: #2a5298;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stats-box {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stats-box h4 {
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        .stats-box .number {
            font-size: 24px;
            font-weight: bold;
        }

        .legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .loading i {
            color: #1e3c72;
            margin-right: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 250px;
                order: 2;
            }
            
            .map-container {
                order: 1;
                height: calc(100vh - 330px);
            }
        }

        /* Custom Leaflet popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .popup-content {
            font-size: 13px;
        }

        .popup-content h4 {
            color: #1e3c72;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .popup-content .info-item {
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .popup-content .info-label {
            font-weight: 500;
            color: #495057;
        }

        .popup-content .info-value {
            color: #212529;
        }

        .zone-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .zone-norte { background: #e3f2fd; color: #1565c0; }
        .zone-centro { background: #f3e5f5; color: #7b1fa2; }
        .zone-sul { background: #fff3e0; color: #f57c00; }

        /* Estilos para modo de edição */
        .edit-mode-active {
            cursor: move !important;
        }
        
        .marker-editing {
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.4) !important;
        }

        .marker-edited {
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.6) !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .edit-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideInRight 0.3s ease;
        }

        .edit-notification.error {
            background: #dc3545;
        }

        .edit-notification.warning {
            background: #ffc107;
            color: #212529;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .edit-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 3000;
            max-width: 400px;
            width: 90%;
        }

        .edit-confirmation h4 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .edit-confirmation .coordinates {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            font-size: 13px;
        }

        .edit-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2500;
        }

        /* Estilos para controle EOX Layers */
        .eox-layer-control {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            max-width: 280px;
            min-width: 250px;
        }

        .eox-control-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .eox-control-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .eox-toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .eox-toggle-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .eox-control-content {
            padding: 15px;
        }

        .eox-section {
            margin-bottom: 15px;
        }

        .eox-section:last-child {
            margin-bottom: 0;
        }

        .eox-section h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
        }

        .eox-layer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .eox-layer-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .eox-layer-btn:hover {
            background: #e9ecef;
            border-color: #1e3c72;
        }

        .eox-layer-btn.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .eox-overlay-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .eox-overlay-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eox-overlay-btn:hover {
            background: #e9ecef;
            border-color: #28a745;
        }

        .eox-overlay-btn.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .eox-layer-control.collapsed .eox-control-content {
            display: none;
        }

        .eox-layer-control.collapsed .eox-toggle-btn {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <i class="fas fa-anchor"></i>
            QGIS - Infraestruturas Pesqueiras de Angola
        </h1>
        <div class="subtitle">
            Sistema de gestão de portos pesqueiros e vilas pescatórias da ZEE angolana
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <!-- Estatísticas -->
            <div class="sidebar-section">
                <div class="stats-box">
                    <h4>Total de Infraestruturas</h4>
                    <div class="number" id="total-features">24</div>
                </div>
            </div>

            <!-- Controle de Camadas -->
            <div class="sidebar-section">
                <h3><i class="fas fa-layer-group"></i> Camadas</h3>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-ports" checked>
                        <i class="fas fa-ship" style="color: #1e3c72;"></i>
                        Portos Pesqueiros
                    </label>
                </div>

                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-villages" checked>
                        <i class="fas fa-home" style="color: #28a745;"></i>
                        Vilas Pescatórias
                    </label>
                </div>

                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-infrastructure" checked>
                        <i class="fas fa-industry" style="color: #dc3545;"></i>
                        Infraestruturas Complementares
                    </label>
                </div>

                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-zee">
                        <i class="fas fa-water" style="color: #17a2b8;"></i>
                        Zona Econômica Exclusiva
                    </label>
                </div>
            </div>

            <!-- Filtros -->
            <div class="sidebar-section">
                <h3><i class="fas fa-filter"></i> Filtros</h3>
                
                <div class="filter-section">
                    <label for="zone-filter">Zona Pesqueira:</label>
                    <select id="zone-filter">
                        <option value="all">Todas as Zonas</option>
                        <option value="zona_norte">Zona Norte (Cabinda-Luanda)</option>
                        <option value="zona_centro">Zona Centro (Luanda-Lobito)</option>
                        <option value="zona_sul">Zona Sul (Lobito-Cunene)</option>
                    </select>
                </div>

                <div class="filter-section">
                    <label for="type-filter">Tipo de Infraestrutura:</label>
                    <select id="type-filter">
                        <option value="all">Todos os Tipos</option>
                        <option value="major_port">Porto Principal</option>
                        <option value="regional_port">Porto Regional</option>
                        <option value="local_port">Porto Local</option>
                        <option value="fishing_village">Vila Pescatória</option>
                        <option value="processing_plant">Fábrica</option>
                        <option value="shipyard">Estaleiro</option>
                        <option value="fish_market">Mercado</option>
                    </select>
                </div>

                <div class="filter-section">
                    <label for="population-filter">População Mínima:</label>
                    <input type="number" id="population-filter" placeholder="Ex: 1000" min="0">
                </div>
            </div>

            <!-- Ferramentas -->
            <div class="sidebar-section">
                <h3><i class="fas fa-tools"></i> Ferramentas</h3>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="fitToData()">
                        <i class="fas fa-expand"></i>
                        Ajustar Vista
                    </button>
                    
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-eraser"></i>
                        Limpar Filtros
                    </button>
                </div>

                <!-- Ferramentas de Edição -->
                <div class="btn-group" style="margin-top: 15px;">
                    <button class="btn btn-warning" id="edit-mode-btn" onclick="toggleEditMode()">
                        <i class="fas fa-edit"></i>
                        <span id="edit-mode-text">Ativar Edição</span>
                    </button>
                    
                    <button class="btn btn-success" id="save-edits-btn" onclick="saveAllEdits()" style="display: none;">
                        <i class="fas fa-save"></i>
                        Salvar Alterações
                    </button>
                </div>

                <div class="btn-group" style="margin-top: 10px;">
                    <button class="btn btn-success" onclick="exportData('geojson')">
                        <i class="fas fa-download"></i>
                        Exportar GeoJSON
                    </button>
                    
                    <button class="btn btn-success" onclick="exportData('csv')">
                        <i class="fas fa-file-csv"></i>
                        Exportar CSV
                    </button>
                </div>

                <!-- Status de Edição -->
                <div id="edit-status" style="display: none; margin-top: 15px;">
                    <div class="stats-box" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                        <h4>Modo de Edição Ativo</h4>
                        <div class="number" id="edited-count">0</div>
                        <small>pontos modificados</small>
                    </div>
                </div>
            </div>

            <!-- Legenda -->
            <div class="sidebar-section">
                <h3><i class="fas fa-map-signs"></i> Legenda</h3>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #1e3c72;"></div>
                        <span>Portos Pesqueiros</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>Vilas Pescatórias</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc3545;"></div>
                        <span>Fábricas/Estaleiros</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc107;"></div>
                        <span>Mercados de Peixe</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loading">
                <i class="fas fa-spinner fa-spin"></i>
                Carregando dados geoespaciais...
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="assets/js/zee_angola_official.js?v=20250831"></script>
    <script src="assets/js/eox-layers.js?v=20250901"></script>
    
    <script>
        // Configuração do mapa
        const map = L.map('map', {
            center: [-12.5, 13.5], // Centro de Angola
            zoom: 6,
            minZoom: 5,
            maxZoom: 18
        });

        // Inicializar EOX Layers para infraestruturas pesqueiras
        const eoxManager = new EOXLayersManager();
        eoxManager.setupRateLimiting();
        eoxManager.createLayerControl(map);
        
        // Tentar inicializar com terrain-light primeiro, fallback para OSM se necessário
        console.log('🌍 Inicializando layers de fundo...');
        let layerInitialized = false;
        
        // Tentar terrain-light primeiro (mais estável)
        try {
            layerInitialized = eoxManager.initializeDefault(map, 'terrain-light');
            console.log('✅ Terrain Light inicializado');
        } catch (error) {
            console.warn('⚠️ Erro no Terrain Light:', error);
        }
        
        // Se terrain-light falhar, tentar OSM
        if (!layerInitialized) {
            try {
                eoxManager.initializeDefault(map, 'osm');
                console.log('✅ OpenStreetMap inicializado como fallback');
            } catch (error) {
                console.error('❌ Erro ao inicializar qualquer layer:', error);
            }
        }
        
        // Verificar se o mapa carregou após 3 segundos
        setTimeout(() => {
            const mapContainer = map.getContainer();
            const tiles = mapContainer.querySelectorAll('.leaflet-tile');
            const visibleTiles = Array.from(tiles).filter(tile => 
                tile.style.opacity !== '0' && !tile.src.includes('data:image')
            );
            
            if (visibleTiles.length === 0) {
                console.warn('🔄 Mapa ainda vazio, forçando OSM...');
                eoxManager.setBackgroundLayer(map, 'osm');
                
                // Atualizar botão ativo
                document.querySelectorAll('.eox-layer-btn').forEach(btn => btn.classList.remove('active'));
                const osmBtn = document.querySelector('[data-layer="osm"]');
                if (osmBtn) osmBtn.classList.add('active');
            }
        }, 3000);

        // Grupos de camadas
        const layerGroups = {
            ports: L.layerGroup(),
            villages: L.layerGroup(),
            infrastructure: L.layerGroup(),
            zee: L.layerGroup()
        };

        // Adicionar grupos ao mapa
        Object.values(layerGroups).forEach(group => group.addTo(map));

        // Dados carregados
        let allData = {
            ports: [],
            villages: [],
            infrastructure: []
        };

        // Sistema de edição
        let editMode = false;
        let editedFeatures = new Map(); // feature_id -> {originalCoords, newCoords, collection, feature}
        let draggedMarkers = new Set();
        let currentEditingMarker = null;

        // Estilos dos marcadores
        const markerStyles = {
            major_port: { color: '#1e3c72', radius: 10, icon: '⚓' },
            regional_port: { color: '#2a5298', radius: 8, icon: '⚓' },
            local_port: { color: '#4a90e2', radius: 6, icon: '⚓' },
            fishing_village: { color: '#28a745', radius: 7, icon: '🏠' },
            processing_plant: { color: '#dc3545', radius: 8, icon: '🏭' },
            shipyard: { color: '#fd7e14', radius: 7, icon: '🔧' },
            fish_market: { color: '#ffc107', radius: 6, icon: '🐟' },
            canning_factory: { color: '#e83e8c', radius: 8, icon: '🏭' },
            fishmeal_plant: { color: '#6610f2', radius: 8, icon: '🏭' },
            repair_yard: { color: '#fd7e14', radius: 6, icon: '🔧' },
            wholesale_market: { color: '#20c997', radius: 7, icon: '🐟' }
        };

        // Função para criar marcador customizado
        function createCustomMarker(feature, style, collection, featureIndex) {
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            
            const marker = L.circleMarker([coords[1], coords[0]], {
                radius: style.radius,
                fillColor: style.color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });

            // Adicionar metadados para edição
            marker.featureId = props.id || featureIndex;
            marker.collection = collection;
            marker.originalFeature = feature;
            marker.originalCoords = [coords[0], coords[1]]; // [lng, lat]

            // Popup personalizado
            const popupContent = createPopupContent(props);
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'custom-popup'
            });

            // Eventos de edição
            setupMarkerEditEvents(marker);

            return marker;
        }

        // Configurar eventos de edição para marcadores
        function setupMarkerEditEvents(marker) {
            marker.on('mousedown', function(e) {
                if (!editMode) return;
                
                currentEditingMarker = marker;
                marker.getElement().classList.add('marker-editing');
                
                // Prevenir propagação do evento
                L.DomEvent.stopPropagation(e);
                
                // Iniciar drag
                map.dragging.disable();
                map.on('mousemove', onMarkerDrag);
                map.on('mouseup', onMarkerDragEnd);
            });

            marker.on('click', function(e) {
                if (editMode) {
                    L.DomEvent.stopPropagation(e);
                    showEditConfirmation(marker);
                }
            });
        }

        // Função de drag do marcador
        function onMarkerDrag(e) {
            if (!currentEditingMarker) return;
            
            const newLatLng = e.latlng;
            currentEditingMarker.setLatLng(newLatLng);
        }

        // Finalizar drag do marcador
        function onMarkerDragEnd(e) {
            if (!currentEditingMarker) return;
            
            map.dragging.enable();
            map.off('mousemove', onMarkerDrag);
            map.off('mouseup', onMarkerDragEnd);
            
            const marker = currentEditingMarker;
            const newLatLng = marker.getLatLng();
            const newCoords = [newLatLng.lng, newLatLng.lat]; // [lng, lat] para GeoJSON
            
            // Validar coordenadas
            if (!isValidCoordinate(newCoords)) {
                showNotification('Coordenadas inválidas! Posição revertida.', 'error');
                marker.setLatLng([marker.originalCoords[1], marker.originalCoords[0]]);
                marker.getElement().classList.remove('marker-editing');
                currentEditingMarker = null;
                return;
            }
            
            // Registrar alteração
            registerFeatureEdit(marker, newCoords);
            
            marker.getElement().classList.remove('marker-editing');
            marker.getElement().classList.add('marker-edited');
            
            currentEditingMarker = null;
            updateEditedCount();
        }

        // Função para criar conteúdo do popup
        function createPopupContent(props) {
            let content = `
                <div class="popup-content">
                    <h4>${props.name}</h4>
                    <div class="info-item">
                        <span class="info-label">Zona:</span>
                        <span class="zone-badge zone-${props.zone.replace('zona_', '')}">${getZoneName(props.zone)}</span>
                    </div>
            `;

            if (props.population) {
                content += `
                    <div class="info-item">
                        <span class="info-label">População:</span>
                        <span class="info-value">${props.population.toLocaleString()}</span>
                    </div>
                `;
            }

            if (props.capacity_boats) {
                content += `
                    <div class="info-item">
                        <span class="info-label">Capacidade:</span>
                        <span class="info-value">${props.capacity_boats} embarcações</span>
                    </div>
                `;
            }

            if (props.boats) {
                content += `
                    <div class="info-item">
                        <span class="info-label">Embarcações:</span>
                        <span class="info-value">${props.boats}</span>
                    </div>
                `;
            }

            if (props.infrastructure) {
                content += `
                    <div class="info-item">
                        <span class="info-label">Infraestruturas:</span>
                        <span class="info-value">${props.infrastructure.join(', ')}</span>
                    </div>
                `;
            }

            if (props.main_species) {
                content += `
                    <div class="info-item">
                        <span class="info-label">Espécies Principais:</span>
                        <span class="info-value">${props.main_species.slice(0, 2).join(', ')}</span>
                    </div>
                `;
            }

            content += '</div>';
            return content;
        }

        // Função para obter nome da zona
        function getZoneName(zone) {
            const names = {
                'zona_norte': 'Norte',
                'zona_centro': 'Centro', 
                'zona_sul': 'Sul'
            };
            return names[zone] || zone;
        }

        // Função para carregar dados
        async function loadData() {
            try {
                const endpoints = [
                    'http://localhost:5080/collections/fishing_ports/items?f=json&limit=1000',
                    'http://localhost:5080/collections/fishing_villages/items?f=json&limit=1000',
                    'http://localhost:5080/collections/fishing_infrastructure/items?f=json&limit=1000'
                ];

                console.log('Carregando dados dos endpoints:', endpoints);

                const [portsResponse, villagesResponse, infrastructureResponse] = await Promise.all(
                    endpoints.map(url => fetch(url))
                );

                if (!portsResponse.ok || !villagesResponse.ok || !infrastructureResponse.ok) {
                    throw new Error('Erro ao carregar dados dos endpoints');
                }

                allData.ports = await portsResponse.json();
                allData.villages = await villagesResponse.json();
                allData.infrastructure = await infrastructureResponse.json();

                console.log('Dados carregados:', {
                    ports: allData.ports.features?.length || 0,
                    villages: allData.villages.features?.length || 0,
                    infrastructure: allData.infrastructure.features?.length || 0
                });

                renderLayers();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('loading').innerHTML = 
                    '<i class="fas fa-exclamation-triangle"></i> Erro ao carregar dados';
            }
        }

        // Função para renderizar camadas
        function renderLayers() {
            // Limpar camadas existentes
            Object.values(layerGroups).forEach(group => group.clearLayers());

            // Renderizar portos
            if (allData.ports.features) {
                allData.ports.features.forEach((feature, index) => {
                    const style = markerStyles[feature.properties.type] || markerStyles.major_port;
                    const marker = createCustomMarker(feature, style, 'ports', index);
                    layerGroups.ports.addLayer(marker);
                });
            }

            // Renderizar vilas
            if (allData.villages.features) {
                allData.villages.features.forEach((feature, index) => {
                    const style = markerStyles.fishing_village;
                    const marker = createCustomMarker(feature, style, 'villages', index);
                    layerGroups.villages.addLayer(marker);
                });
            }

            // Renderizar infraestruturas
            if (allData.infrastructure.features) {
                allData.infrastructure.features.forEach((feature, index) => {
                    const style = markerStyles[feature.properties.type] || markerStyles.processing_plant;
                    const marker = createCustomMarker(feature, style, 'infrastructure', index);
                    layerGroups.infrastructure.addLayer(marker);
                });
            }
        }

        // ===============================================================================
        // SISTEMA DE EDIÇÃO
        // ===============================================================================

        // Alternar modo de edição
        function toggleEditMode() {
            editMode = !editMode;
            
            const editBtn = document.getElementById('edit-mode-btn');
            const editText = document.getElementById('edit-mode-text');
            const saveBtn = document.getElementById('save-edits-btn');
            const editStatus = document.getElementById('edit-status');
            
            if (editMode) {
                editBtn.className = 'btn btn-danger';
                editText.textContent = 'Desativar Edição';
                saveBtn.style.display = 'inline-flex';
                editStatus.style.display = 'block';
                
                // Adicionar cursor de edição ao mapa
                map.getContainer().classList.add('edit-mode-active');
                
                showNotification('Modo de edição ativado! Arraste os pontos para reposicioná-los.', 'warning');
                
            } else {
                editBtn.className = 'btn btn-warning';
                editText.textContent = 'Ativar Edição';
                saveBtn.style.display = 'none';
                editStatus.style.display = 'none';
                
                // Remover cursor de edição
                map.getContainer().classList.remove('edit-mode-active');
                
                // Limpar marcadores editados visualmente
                document.querySelectorAll('.marker-edited').forEach(el => {
                    el.classList.remove('marker-edited');
                });
                
                showNotification('Modo de edição desativado.', 'success');
            }
        }

        // Registrar edição de feature
        function registerFeatureEdit(marker, newCoords) {
            const featureId = marker.featureId;
            const collection = marker.collection;
            
            // Criar nova feature com coordenadas atualizadas
            const updatedFeature = {
                ...marker.originalFeature,
                geometry: {
                    ...marker.originalFeature.geometry,
                    coordinates: newCoords
                }
            };
            
            editedFeatures.set(featureId, {
                originalCoords: marker.originalCoords,
                newCoords: newCoords,
                collection: collection,
                feature: updatedFeature,
                marker: marker
            });
            
            console.log(`Feature ${featureId} editada:`, {
                collection,
                original: marker.originalCoords,
                new: newCoords
            });
        }

        // Validar coordenadas
        function isValidCoordinate(coords) {
            const [lng, lat] = coords;
            return lng >= -180 && lng <= 180 && lat >= -90 && lat <= 90;
        }

        // Atualizar contador de edições
        function updateEditedCount() {
            const count = editedFeatures.size;
            document.getElementById('edited-count').textContent = count;
        }

        // Mostrar notificação
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `edit-notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Mostrar confirmação de edição
        function showEditConfirmation(marker) {
            const props = marker.originalFeature.properties;
            const currentLatLng = marker.getLatLng();
            const originalLatLng = [marker.originalCoords[1], marker.originalCoords[0]]; // [lat, lng]
            
            const overlay = document.createElement('div');
            overlay.className = 'edit-overlay';
            
            const confirmation = document.createElement('div');
            confirmation.className = 'edit-confirmation';
            confirmation.innerHTML = `
                <h4><i class="fas fa-edit"></i> Confirmar Edição</h4>
                <p><strong>${props.name || 'Ponto sem nome'}</strong></p>
                <p><strong>Tipo:</strong> ${props.type || 'N/A'}</p>
                
                <div class="coordinates">
                    <strong>Posição Original:</strong><br>
                    Lat: ${originalLatLng[0].toFixed(6)}<br>
                    Lng: ${originalLatLng[1].toFixed(6)}
                </div>
                
                <div class="coordinates">
                    <strong>Nova Posição:</strong><br>
                    Lat: ${currentLatLng.lat.toFixed(6)}<br>
                    Lng: ${currentLatLng.lng.toFixed(6)}
                </div>
                
                <div class="btn-group" style="margin-top: 15px; justify-content: center;">
                    <button class="btn btn-success" onclick="confirmEdit(this, '${marker.featureId}')">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                    <button class="btn btn-secondary" onclick="cancelEdit(this, '${marker.featureId}')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(confirmation);
            
            overlay.onclick = () => cancelEdit(confirmation, marker.featureId);
        }

        // Confirmar edição
        function confirmEdit(element, featureId) {
            const confirmation = element.closest('.edit-confirmation');
            const overlay = document.querySelector('.edit-overlay');
            
            confirmation.remove();
            overlay.remove();
            
            showNotification('Posição atualizada! Lembre-se de salvar as alterações.', 'success');
        }

        // Cancelar edição
        function cancelEdit(element, featureId) {
            const confirmation = element.closest('.edit-confirmation');
            const overlay = document.querySelector('.edit-overlay');
            
            // Reverter posição do marcador
            const editData = editedFeatures.get(featureId);
            if (editData) {
                const marker = editData.marker;
                marker.setLatLng([marker.originalCoords[1], marker.originalCoords[0]]);
                marker.getElement().classList.remove('marker-edited');
                editedFeatures.delete(featureId);
                updateEditedCount();
            }
            
            confirmation.remove();
            overlay.remove();
            
            showNotification('Edição cancelada.', 'warning');
        }

        // Função para atualizar estatísticas
        function updateStats() {
            const portsCount = allData.ports.features?.length || 0;
            const villagesCount = allData.villages.features?.length || 0;
            const infrastructureCount = allData.infrastructure.features?.length || 0;
            const totalFeatures = portsCount + villagesCount + infrastructureCount;
            
            console.log('Estatísticas:', {
                ports: portsCount,
                villages: villagesCount,
                infrastructure: infrastructureCount,
                total: totalFeatures
            });
            
            document.getElementById('total-features').textContent = totalFeatures;
        }

        // Controle de camadas
        document.getElementById('layer-ports').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(layerGroups.ports);
            } else {
                map.removeLayer(layerGroups.ports);
            }
        });

        document.getElementById('layer-villages').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(layerGroups.villages);
            } else {
                map.removeLayer(layerGroups.villages);
            }
        });

        document.getElementById('layer-infrastructure').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(layerGroups.infrastructure);
            } else {
                map.removeLayer(layerGroups.infrastructure);
            }
        });

        document.getElementById('layer-zee').addEventListener('change', function(e) {
            if (e.target.checked) {
                // Carregar ZEE se necessário
                loadZEE();
            } else {
                map.removeLayer(layerGroups.zee);
            }
        });

        // Função para carregar ZEE OFICIAL
        async function loadZEE() {
            try {
                layerGroups.zee.clearLayers();
                
                // Usar dados oficiais do Marine Regions
                if (typeof angolaZEEOfficial !== 'undefined') {
                    const angolaLayer = L.polygon(angolaZEEOfficial, {
                        color: '#0066cc',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.2,
                        fillColor: '#0080ff'
                    });
                    
                    angolaLayer.bindPopup('🌊 ZEE Angola - OFICIAL<br>📏 495.866 km² (Marine Regions)');
                    layerGroups.zee.addLayer(angolaLayer);
                    
                    console.log('✅ ZEE Angola oficial carregada no QGIS');
                }
                
                // Cabinda separada
                if (typeof cabindaZEEOfficial !== 'undefined') {
                    const cabindaLayer = L.polygon(cabindaZEEOfficial, {
                        color: '#9b59b6',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.2,
                        fillColor: '#9b59b6'
                    });
                    
                    cabindaLayer.bindPopup('🏛️ ZEE Cabinda - OFICIAL<br>📍 Marine Regions');
                    layerGroups.zee.addLayer(cabindaLayer);
                    
                    console.log('✅ ZEE Cabinda oficial carregada no QGIS');
                }
                
                map.addLayer(layerGroups.zee);
                
            } catch (error) {
                console.error('Erro ao carregar ZEE oficial:', error);
                
                // Fallback para API antiga se dados oficiais falharem
                try {
                    const response = await fetch('http://localhost:5080/collections/aoi/items?f=json&limit=1000');
                    const zeeData = await response.json();
                    
                    if (zeeData.features) {
                        zeeData.features.forEach(feature => {
                            const layer = L.geoJSON(feature, {
                                style: {
                                    color: '#17a2b8',
                                    weight: 2,
                                    opacity: 0.8,
                                    fillOpacity: 0.1,
                                    fillColor: '#17a2b8'
                                }
                            });
                            layerGroups.zee.addLayer(layer);
                        });
                        
                        map.addLayer(layerGroups.zee);
                    }
                } catch (fallbackError) {
                    console.error('Erro no fallback da ZEE:', fallbackError);
                }
            }
        }

        // Filtros
        function applyFilters() {
            const zoneFilter = document.getElementById('zone-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const populationFilter = parseInt(document.getElementById('population-filter').value) || 0;

            // Implementar lógica de filtros aqui
            // Por simplicidade, apenas recarregamos as camadas
            renderLayers();
        }

        // Event listeners para filtros
        document.getElementById('zone-filter').addEventListener('change', applyFilters);
        document.getElementById('type-filter').addEventListener('change', applyFilters);
        document.getElementById('population-filter').addEventListener('input', applyFilters);

        // Função para ajustar vista
        function fitToData() {
            const group = new L.featureGroup([
                layerGroups.ports,
                layerGroups.villages,
                layerGroups.infrastructure
            ]);
            
            if (group.getLayers().length > 0) {
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
            }
        }

        // Função para limpar filtros
        function clearFilters() {
            document.getElementById('zone-filter').value = 'all';
            document.getElementById('type-filter').value = 'all';
            document.getElementById('population-filter').value = '';
            applyFilters();
        }

        // Salvar todas as edições
        async function saveAllEdits() {
            if (editedFeatures.size === 0) {
                showNotification('Nenhuma alteração para salvar.', 'warning');
                return;
            }
            
            const confirmSave = confirm(`Deseja salvar ${editedFeatures.size} alterações? Esta ação não pode ser desfeita.`);
            if (!confirmSave) return;
            
            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando alterações...';
            document.body.appendChild(loadingDiv);
            
            try {
                let savedCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Processar cada edição
                for (const [featureId, editData] of editedFeatures) {
                    try {
                        const response = await fetch(`/fisheries/feature/${featureId}?collection=${editData.collection}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(editData.feature)
                        });
                        
                        if (response.ok) {
                            savedCount++;
                            // Atualizar dados locais
                            updateLocalData(editData);
                        } else {
                            const errorData = await response.json();
                            errors.push(`${featureId}: ${errorData.detail}`);
                            errorCount++;
                        }
                        
                    } catch (error) {
                        errors.push(`${featureId}: ${error.message}`);
                        errorCount++;
                    }
                }
                
                loadingDiv.remove();
                
                // Mostrar resultado
                if (savedCount > 0) {
                    showNotification(`${savedCount} alterações salvas com sucesso!`, 'success');
                    
                    // Limpar edições salvas
                    editedFeatures.clear();
                    updateEditedCount();
                    
                    // Remover marcadores visuais de edição
                    document.querySelectorAll('.marker-edited').forEach(el => {
                        el.classList.remove('marker-edited');
                    });
                    
                    // Desativar modo de edição
                    if (editMode) {
                        toggleEditMode();
                    }
                }
                
                if (errorCount > 0) {
                    console.error('Erros ao salvar:', errors);
                    showNotification(`${errorCount} erros ao salvar. Verifique o console.`, 'error');
                }
                
            } catch (error) {
                loadingDiv.remove();
                console.error('Erro geral ao salvar:', error);
                showNotification('Erro ao salvar alterações. Tente novamente.', 'error');
            }
        }

        // Atualizar dados locais após salvar
        function updateLocalData(editData) {
            const { collection, feature } = editData;
            const featureId = editData.marker.featureId;
            
            // Encontrar e atualizar nos dados locais
            let targetArray;
            switch (collection) {
                case 'ports':
                    targetArray = allData.ports.features;
                    break;
                case 'villages':
                    targetArray = allData.villages.features;
                    break;
                case 'infrastructure':
                    targetArray = allData.infrastructure.features;
                    break;
            }
            
            if (targetArray) {
                const index = targetArray.findIndex((f, i) => 
                    (f.properties.id && f.properties.id === featureId) || i === featureId
                );
                
                if (index !== -1) {
                    targetArray[index] = feature;
                    // Atualizar coordenadas originais do marcador
                    editData.marker.originalCoords = feature.geometry.coordinates;
                }
            }
        }

        // Função para exportar dados
        function exportData(format) {
            const allFeatures = [
                ...(allData.ports.features || []),
                ...(allData.villages.features || []),
                ...(allData.infrastructure.features || [])
            ];

            if (format === 'geojson') {
                const geojson = {
                    type: 'FeatureCollection',
                    features: allFeatures
                };
                
                const blob = new Blob([JSON.stringify(geojson, null, 2)], 
                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'infraestruturas_pesqueiras_angola.geojson';
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'csv') {
                // Implementar exportação CSV
                alert('Funcionalidade CSV em desenvolvimento');
            }
        }

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>
