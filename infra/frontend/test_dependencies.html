<!DOCTYPE html>
<html lang="pt">
<head>
    <!-- Favicon BGAPP -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="theme-color" content="#173c72">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGAPP - Teste de Depend√™ncias</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #00ff00;
            border-radius: 10px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #2a2a2a;
        }
        
        .test-item {
            margin: 10px 0;
            padding: 8px;
            border-left: 3px solid #666;
            background: #333;
        }
        
        .success {
            border-left-color: #00ff00;
            color: #00ff00;
        }
        
        .error {
            border-left-color: #ff4444;
            color: #ff4444;
        }
        
        .warning {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }
        
        .info {
            border-left-color: #00aaff;
            color: #00aaff;
        }
        
        .log-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        
        button:hover {
            background: #00aa00;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç BGAPP - TESTE DE DEPEND√äNCIAS</h1>
            <p>Sistema de Diagn√≥stico para realtime_angola.html</p>
            <div>
                <button onclick="runAllTests()">üß™ Executar Todos os Testes</button>
                <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
                <button onclick="exportReport()">üìÑ Exportar Relat√≥rio</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Testes Executados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Sucessos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Falhas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="testTime">0ms</div>
                <div class="stat-label">Tempo Total</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìã RESULTADOS DOS TESTES</h3>
            <div id="testResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä LOG DETALHADO</h3>
            <div class="log-output" id="logOutput"></div>
        </div>
    </div>

    <script>
        let testResults = [];
        let testStats = { total: 0, passed: 0, failed: 0, startTime: 0 };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            const logOutput = document.getElementById('logOutput');
            logOutput.textContent += logEntry + '\n';
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(logEntry);
        }
        
        function addTestResult(testName, status, message, details = null) {
            testResults.push({ testName, status, message, details, timestamp: new Date() });
            
            testStats.total++;
            if (status === 'success') {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            
            updateStats();
            updateResultsDisplay();
        }
        
        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            
            if (testStats.startTime > 0) {
                const elapsed = Date.now() - testStats.startTime;
                document.getElementById('testTime').textContent = elapsed + 'ms';
            }
        }
        
        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-item ${result.status}`;
                
                const icon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                div.innerHTML = `
                    <strong>${icon} ${result.testName}</strong><br>
                    ${result.message}
                    ${result.details ? `<br><small>${result.details}</small>` : ''}
                `;
                
                resultsDiv.appendChild(div);
            });
        }
        
        async function runAllTests() {
            log('Iniciando bateria completa de testes...', 'info');
            testStats.startTime = Date.now();
            testResults = [];
            testStats.total = testStats.passed = testStats.failed = 0;
            
            // Testes b√°sicos do navegador
            await testBrowserCapabilities();
            
            // Testes de depend√™ncias externas
            await testExternalDependencies();
            
            // Testes de arquivos locais
            await testLocalFiles();
            
            // Testes de APIs
            await testAPIs();
            
            // Testes do Leaflet
            await testLeafletIntegration();
            
            log('Todos os testes conclu√≠dos!', 'success');
            
            // Relat√≥rio final
            const successRate = ((testStats.passed / testStats.total) * 100).toFixed(1);
            log(`Relat√≥rio Final: ${testStats.passed}/${testStats.total} testes passou (${successRate}%)`, 'info');
        }
        
        async function testBrowserCapabilities() {
            log('Testando capacidades do navegador...', 'info');
            
            // Teste de JavaScript ES6
            try {
                const testArrow = () => 'OK';
                const testTemplate = `Template literal works`;
                addTestResult('JavaScript ES6', 'success', 'Arrow functions e template literals funcionando');
            } catch (error) {
                addTestResult('JavaScript ES6', 'error', 'Problemas com ES6: ' + error.message);
            }
            
            // Teste de Fetch API
            if (typeof fetch !== 'undefined') {
                addTestResult('Fetch API', 'success', 'Fetch API dispon√≠vel');
            } else {
                addTestResult('Fetch API', 'error', 'Fetch API n√£o dispon√≠vel - usar polyfill');
            }
            
            // Teste de Local Storage
            try {
                localStorage.setItem('bgapp_test', 'test');
                localStorage.removeItem('bgapp_test');
                addTestResult('Local Storage', 'success', 'Local Storage funcionando');
            } catch (error) {
                addTestResult('Local Storage', 'error', 'Local Storage bloqueado: ' + error.message);
            }
            
            // Teste de Console
            if (typeof console !== 'undefined' && console.log) {
                addTestResult('Console API', 'success', 'Console dispon√≠vel para debug');
            } else {
                addTestResult('Console API', 'error', 'Console n√£o dispon√≠vel');
            }
        }
        
        async function testExternalDependencies() {
            log('Testando depend√™ncias externas...', 'info');
            
            // Teste Leaflet CSS - verificar se est√° carregado via CDN
            try {
                const response = await fetch('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css', { method: 'HEAD' });
                if (response.ok) {
                    // Verificar se CSS est√° aplicado na p√°gina
                    const leafletCSS = document.querySelector('link[href*="leaflet"]');
                    if (leafletCSS) {
                        addTestResult('Leaflet CSS', 'success', 'Link CSS encontrado e CDN acess√≠vel');
                    } else {
                        addTestResult('Leaflet CSS', 'warning', 'CDN acess√≠vel mas link n√£o encontrado no HTML');
                    }
                } else {
                    addTestResult('Leaflet CSS', 'error', `Leaflet CSS CDN retornou ${response.status}`);
                }
            } catch (error) {
                addTestResult('Leaflet CSS', 'error', 'Erro ao acessar Leaflet CSS: ' + error.message);
            }
            
            // Teste Chart.js
            try {
                const response = await fetch('https://cdn.jsdelivr.net/npm/chart.js', { method: 'HEAD' });
                if (response.ok) {
                    addTestResult('Chart.js CDN', 'success', 'Chart.js CDN acess√≠vel');
                } else {
                    addTestResult('Chart.js CDN', 'error', `Chart.js CDN retornou ${response.status}`);
                }
            } catch (error) {
                addTestResult('Chart.js CDN', 'error', 'Erro ao acessar Chart.js: ' + error.message);
            }
            
            // Teste Leaflet JS
            try {
                const response = await fetch('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', { method: 'HEAD' });
                if (response.ok) {
                    addTestResult('Leaflet JS CDN', 'success', 'Leaflet JS CDN acess√≠vel');
                } else {
                    addTestResult('Leaflet JS CDN', 'error', `Leaflet JS CDN retornou ${response.status}`);
                }
            } catch (error) {
                addTestResult('Leaflet JS CDN', 'error', 'Erro ao acessar Leaflet JS: ' + error.message);
            }
        }
        
        async function testLocalFiles() {
            log('Testando arquivos locais...', 'info');
            
            const localFiles = [
                'assets/js/aguas_internas.js',
                'assets/js/zee_angola_official.js',
                'assets/js/coastlines_official.js',
                'assets/js/eox-layers.js',
                'copernicus_authenticated_angola.json'
            ];
            
            for (const file of localFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        addTestResult(`Arquivo Local: ${file}`, 'success', `Arquivo encontrado (${response.status})`);
                    } else {
                        addTestResult(`Arquivo Local: ${file}`, 'error', `Arquivo n√£o encontrado (${response.status})`);
                    }
                } catch (error) {
                    addTestResult(`Arquivo Local: ${file}`, 'error', `Erro ao acessar: ${error.message}`);
                }
            }
        }
        
        async function testAPIs() {
            log('Testando APIs e dados...', 'info');
            
            // Teste dados JSON do Copernicus
            try {
                const response = await fetch('copernicus_authenticated_angola.json');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.source && data.real_time_data) {
                        addTestResult('Dados Copernicus', 'success', 
                            `JSON v√°lido com ${data.real_time_data.length} pontos de dados`);
                        
                        // Validar estrutura dos dados
                        const firstPoint = data.real_time_data[0];
                        if (firstPoint.sst && firstPoint.lat && firstPoint.lon) {
                            addTestResult('Estrutura Dados', 'success', 'Campos obrigat√≥rios presentes');
                        } else {
                            addTestResult('Estrutura Dados', 'error', 'Campos obrigat√≥rios ausentes');
                        }
                    } else {
                        addTestResult('Dados Copernicus', 'error', 'Estrutura JSON inv√°lida');
                    }
                } else {
                    addTestResult('Dados Copernicus', 'error', `HTTP ${response.status}`);
                }
            } catch (error) {
                addTestResult('Dados Copernicus', 'error', error.message);
            }
        }
        
        async function testLeafletIntegration() {
            log('Testando integra√ß√£o Leaflet...', 'info');
            
            // Aguardar mais tempo para garantir que scripts carregaram
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Verificar se script Leaflet est√° no DOM
            const leafletScript = document.querySelector('script[src*="leaflet"]');
            if (leafletScript) {
                log('Script Leaflet encontrado no DOM: ' + leafletScript.src, 'info');
            } else {
                log('Script Leaflet N√ÉO encontrado no DOM', 'warning');
            }
            
            if (typeof L !== 'undefined') {
                addTestResult('Leaflet Global', 'success', 'Objeto L dispon√≠vel globalmente');
                
                try {
                    // Teste b√°sico de cria√ß√£o de mapa
                    const testDiv = document.createElement('div');
                    testDiv.style.height = '100px';
                    testDiv.style.width = '100px';
                    testDiv.style.position = 'absolute';
                    testDiv.style.left = '-9999px';
                    document.body.appendChild(testDiv);
                    
                    const testMap = L.map(testDiv).setView([-12.5, 13.5], 6);
                    
                    if (testMap) {
                        addTestResult('Cria√ß√£o Mapa', 'success', 'Mapa Leaflet criado com sucesso');
                        
                        // Teste de tile layer
                        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
                        tileLayer.addTo(testMap);
                        addTestResult('Tile Layer', 'success', 'Tile layer adicionado');
                        
                        // Teste de pol√≠gono
                        const testPolygon = L.polygon([[-12, 13], [-12, 14], [-13, 14], [-13, 13]]);
                        testPolygon.addTo(testMap);
                        addTestResult('Pol√≠gono', 'success', 'Pol√≠gono adicionado ao mapa');
                        
                        // Limpeza
                        testMap.remove();
                        document.body.removeChild(testDiv);
                    }
                } catch (error) {
                    addTestResult('Cria√ß√£o Mapa', 'error', 'Erro ao criar mapa: ' + error.message);
                }
            } else {
                // Debug mais detalhado
                const windowKeys = Object.keys(window).filter(key => key.toLowerCase().includes('leaf'));
                const scriptTags = Array.from(document.querySelectorAll('script')).map(s => s.src).filter(src => src.includes('leaflet'));
                
                let debugInfo = 'Objeto L n√£o encontrado. ';
                if (scriptTags.length > 0) {
                    debugInfo += `Scripts Leaflet no DOM: ${scriptTags.length}. `;
                }
                if (windowKeys.length > 0) {
                    debugInfo += `Chaves relacionadas: ${windowKeys.join(', ')}.`;
                }
                
                addTestResult('Leaflet Global', 'error', debugInfo);
                
                // Tentar carregar Leaflet manualmente para teste
                try {
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                    script.onload = () => {
                        if (typeof L !== 'undefined') {
                            addTestResult('Leaflet Manual Load', 'success', 'Leaflet carregado manualmente com sucesso');
                        }
                    };
                    document.head.appendChild(script);
                } catch (error) {
                    addTestResult('Leaflet Manual Load', 'error', 'Erro ao carregar manualmente: ' + error.message);
                }
            }
        }
        
        function clearLog() {
            document.getElementById('logOutput').textContent = '';
            log('Log limpo', 'info');
        }
        
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                stats: testStats,
                results: testResults,
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], 
                { type: 'application/json' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bgapp_test_report_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Relat√≥rio exportado', 'success');
        }
        
        // Auto-executar testes quando a p√°gina carrega
        window.addEventListener('load', () => {
            log('P√°gina carregada, iniciando testes autom√°ticos...', 'info');
            // Aguardar mais tempo para garantir que todos os recursos carregaram
            setTimeout(runAllTests, 2000);
        });
        
        // Adicionar teste espec√≠fico para verificar se Leaflet est√° no contexto correto
        function testLeafletInCurrentPage() {
            log('Testando Leaflet na p√°gina atual...', 'info');
            
            // Verificar se scripts est√£o no DOM
            const leafletCSS = document.querySelector('link[href*="leaflet"]');
            const leafletJS = document.querySelector('script[src*="leaflet"]');
            
            console.log('CSS Leaflet no DOM:', leafletCSS ? leafletCSS.href : 'N√ÉO ENCONTRADO');
            console.log('JS Leaflet no DOM:', leafletJS ? leafletJS.src : 'N√ÉO ENCONTRADO');
            console.log('Objeto L dispon√≠vel:', typeof L !== 'undefined' ? 'SIM' : 'N√ÉO');
            
            if (typeof L !== 'undefined') {
                console.log('Vers√£o do Leaflet:', L.version || 'Vers√£o n√£o dispon√≠vel');
                console.log('M√©todos principais:', {
                    map: typeof L.map,
                    tileLayer: typeof L.tileLayer,
                    polygon: typeof L.polygon
                });
            }
        }
        
        // Executar teste espec√≠fico ap√≥s 5 segundos
        setTimeout(testLeafletInCurrentPage, 5000);
    </script>
</body>
</html>
