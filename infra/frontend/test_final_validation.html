<!DOCTYPE html>
<html lang="pt">
<head>
    <!-- Favicon BGAPP -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="theme-color" content="#173c72">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGAPP - Valida√ß√£o Final das Corre√ß√µes</title>
    
    <!-- Incluir Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f3460 0%, #16537e 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
        }
        
        .status-ok { border-left: 4px solid #00ff88; }
        .status-error { border-left: 4px solid #ff4444; }
        .status-warning { border-left: 4px solid #ffaa00; }
        .status-loading { border-left: 4px solid #00aaff; }
        
        .status-icon {
            font-size: 20px;
        }
        
        .test-map {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .log-section {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        button {
            background: linear-gradient(45deg, #00d4ff, #0080ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .success-rate {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ BGAPP - VALIDA√á√ÉO FINAL DAS CORRE√á√ïES</h1>
            <p>Teste completo ap√≥s implementa√ß√£o das corre√ß√µes de timing do Leaflet</p>
            <div class="success-rate" id="successRate">Carregando...</div>
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>üîß Status do Sistema</h3>
                <div class="status-item status-loading" id="leafletStatus">
                    <span>Leaflet Global</span>
                    <span class="status-icon">‚è≥</span>
                </div>
                <div class="status-item status-loading" id="cssStatus">
                    <span>Leaflet CSS</span>
                    <span class="status-icon">‚è≥</span>
                </div>
                <div class="status-item status-loading" id="timingStatus">
                    <span>Timing de Carregamento</span>
                    <span class="status-icon">‚è≥</span>
                </div>
                <div class="status-item status-loading" id="fallbackStatus">
                    <span>Sistema de Fallback</span>
                    <span class="status-icon">‚è≥</span>
                </div>
            </div>
            
            <div class="status-card">
                <h3>üìä M√©tricas de Performance</h3>
                <div class="status-item">
                    <span>Tempo de Carregamento</span>
                    <span id="loadTime">-- ms</span>
                </div>
                <div class="status-item">
                    <span>Tentativas Leaflet</span>
                    <span id="leafletAttempts">--</span>
                </div>
                <div class="status-item">
                    <span>Scripts Carregados</span>
                    <span id="scriptsLoaded">0/4</span>
                </div>
                <div class="status-item">
                    <span>Taxa de Sucesso</span>
                    <span id="successRateSmall">--%</span>
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <h3>üó∫Ô∏è Teste Visual do Mapa</h3>
            <div id="testMap" class="test-map"></div>
            <div style="text-align: center; margin-top: 10px;">
                <button onclick="testMapFunctionality()">üß™ Testar Funcionalidades</button>
                <button onclick="resetMap()">üîÑ Resetar Mapa</button>
            </div>
        </div>
        
        <div class="log-section">
            <h4>üìã Log de Valida√ß√£o em Tempo Real</h4>
            <div id="validationLog"></div>
        </div>
    </div>

    <!-- Incluir Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    
    <script>
        let validationResults = {
            leafletGlobal: false,
            leafletCSS: false,
            timingFixed: false,
            fallbackWorks: false,
            mapCreated: false,
            totalTests: 0,
            passedTests: 0,
            startTime: Date.now(),
            leafletAttempts: 0
        };
        
        let testMap = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('pt-PT');
            const logDiv = document.getElementById('validationLog');
            
            const colors = {
                info: '#00aaff',
                success: '#00ff88', 
                error: '#ff4444',
                warning: '#ffaa00'
            };
            
            const color = colors[type] || '#ffffff';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[VALIDA√á√ÉO] ${message}`);
        }
        
        function updateStatus(elementId, success, details = '') {
            const element = document.getElementById(elementId);
            const statusIcon = element.querySelector('.status-icon');
            
            if (success) {
                element.className = 'status-item status-ok';
                statusIcon.textContent = '‚úÖ';
                validationResults.passedTests++;
            } else {
                element.className = 'status-item status-error';
                statusIcon.textContent = '‚ùå';
            }
            
            validationResults.totalTests++;
            updateSuccessRate();
            
            if (details) {
                element.title = details;
            }
        }
        
        function updateSuccessRate() {
            const rate = validationResults.totalTests > 0 
                ? Math.round((validationResults.passedTests / validationResults.totalTests) * 100)
                : 0;
            
            document.getElementById('successRate').textContent = rate + '%';
            document.getElementById('successRateSmall').textContent = rate + '%';
            
            // Atualizar outras m√©tricas
            const elapsed = Date.now() - validationResults.startTime;
            document.getElementById('loadTime').textContent = elapsed + ' ms';
            document.getElementById('leafletAttempts').textContent = validationResults.leafletAttempts;
        }
        
        async function waitForLeaflet(maxAttempts = 20) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                
                function checkLeaflet() {
                    attempts++;
                    validationResults.leafletAttempts = attempts;
                    updateSuccessRate();
                    
                    if (typeof L !== 'undefined') {
                        log(`‚úÖ Leaflet carregado na tentativa ${attempts}`, 'success');
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        log(`‚ùå Leaflet n√£o carregou ap√≥s ${maxAttempts} tentativas`, 'error');
                        reject(new Error('Leaflet timeout'));
                    } else {
                        log(`‚è≥ Aguardando Leaflet... tentativa ${attempts}/${maxAttempts}`, 'info');
                        setTimeout(checkLeaflet, 300);
                    }
                }
                
                checkLeaflet();
            });
        }
        
        async function validateSystem() {
            log('üéØ Iniciando valida√ß√£o completa do sistema...', 'info');
            
            // Teste 1: Leaflet CSS
            const leafletCSS = document.querySelector('link[href*="leaflet"]');
            if (leafletCSS) {
                log('‚úÖ Leaflet CSS encontrado no HTML', 'success');
                validationResults.leafletCSS = true;
                updateStatus('cssStatus', true, 'CSS carregado: ' + leafletCSS.href);
            } else {
                log('‚ùå Leaflet CSS n√£o encontrado', 'error');
                updateStatus('cssStatus', false, 'Link CSS ausente no HTML');
            }
            
            // Teste 2: Timing de carregamento do Leaflet
            try {
                await waitForLeaflet();
                log('‚úÖ Sistema de timing funcionando corretamente', 'success');
                validationResults.timingFixed = true;
                validationResults.leafletGlobal = true;
                updateStatus('timingStatus', true, `Carregou em ${validationResults.leafletAttempts} tentativas`);
                updateStatus('leafletStatus', true, 'Objeto L dispon√≠vel: v' + (L.version || 'unknown'));
                
                // Teste 3: Cria√ß√£o do mapa
                await testMapCreation();
                
            } catch (error) {
                log('‚ö†Ô∏è Leaflet n√£o carregou normalmente, testando fallback...', 'warning');
                updateStatus('timingStatus', false, 'Timeout no carregamento normal');
                updateStatus('leafletStatus', false, 'Objeto L n√£o dispon√≠vel');
                
                // Teste 4: Sistema de fallback
                await testFallbackSystem();
            }
            
            // Relat√≥rio final
            const elapsed = Date.now() - validationResults.startTime;
            const successRate = Math.round((validationResults.passedTests / validationResults.totalTests) * 100);
            
            log(`üéâ Valida√ß√£o conclu√≠da em ${elapsed}ms`, 'success');
            log(`üìä Taxa de sucesso: ${validationResults.passedTests}/${validationResults.totalTests} (${successRate}%)`, 'info');
            
            if (successRate >= 80) {
                log('üöÄ Sistema APROVADO para produ√ß√£o!', 'success');
            } else if (successRate >= 60) {
                log('‚ö†Ô∏è Sistema PARCIALMENTE funcional', 'warning');
            } else {
                log('‚ùå Sistema PRECISA de corre√ß√µes', 'error');
            }
        }
        
        async function testMapCreation() {
            log('üó∫Ô∏è Testando cria√ß√£o do mapa...', 'info');
            
            try {
                const mapDiv = document.getElementById('testMap');
                mapDiv.innerHTML = ''; // Limpar
                
                testMap = L.map('testMap').setView([-12.5, 13.5], 6);
                
                // Adicionar tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(testMap);
                
                // Adicionar marcador de teste
                L.marker([-12.5, 13.5])
                    .addTo(testMap)
                    .bindPopup('üéØ Valida√ß√£o BGAPP - Mapa funcionando!')
                    .openPopup();
                
                // Adicionar pol√≠gono de teste da ZEE
                const zeeTest = L.polygon([
                    [-10, 12], [-10, 14], [-15, 14], [-15, 12]
                ], {
                    color: '#00ff88',
                    fillOpacity: 0.3
                }).addTo(testMap);
                
                zeeTest.bindPopup('üåä Zona de teste - ZEE Angola');
                
                log('‚úÖ Mapa criado com sucesso', 'success');
                validationResults.mapCreated = true;
                
                // Redimensionar ap√≥s cria√ß√£o
                setTimeout(() => {
                    testMap.invalidateSize();
                    log('üîÑ Mapa redimensionado', 'info');
                }, 500);
                
            } catch (error) {
                log('‚ùå Erro ao criar mapa: ' + error.message, 'error');
            }
        }
        
        async function testFallbackSystem() {
            log('üîÑ Testando sistema de fallback...', 'info');
            
            try {
                // Simular carregamento manual do Leaflet
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                
                const loadPromise = new Promise((resolve, reject) => {
                    script.onload = () => {
                        log('‚úÖ Leaflet carregado via fallback', 'success');
                        validationResults.fallbackWorks = true;
                        validationResults.leafletGlobal = true;
                        updateStatus('fallbackStatus', true, 'Carregamento manual funcionou');
                        updateStatus('leafletStatus', true, 'Objeto L dispon√≠vel via fallback');
                        resolve();
                    };
                    script.onerror = () => {
                        log('‚ùå Fallback tamb√©m falhou', 'error');
                        updateStatus('fallbackStatus', false, 'Carregamento manual falhou');
                        reject(new Error('Fallback failed'));
                    };
                });
                
                document.head.appendChild(script);
                await loadPromise;
                
                // Tentar criar mapa via fallback
                await testMapCreation();
                
            } catch (error) {
                log('‚ùå Sistema de fallback falhou: ' + error.message, 'error');
                updateStatus('fallbackStatus', false, error.message);
            }
        }
        
        function testMapFunctionality() {
            if (!testMap) {
                log('‚ö†Ô∏è Mapa n√£o est√° criado', 'warning');
                return;
            }
            
            log('üß™ Testando funcionalidades do mapa...', 'info');
            
            try {
                // Testar zoom
                testMap.setZoom(8);
                setTimeout(() => testMap.setZoom(6), 1000);
                
                // Testar pan
                testMap.panTo([-15, 12]);
                setTimeout(() => testMap.panTo([-12.5, 13.5]), 1500);
                
                // Adicionar novo marcador
                const testMarker = L.marker([-8.8, 13.2])
                    .addTo(testMap)
                    .bindPopup('üèôÔ∏è Luanda - Teste din√¢mico');
                
                log('‚úÖ Funcionalidades do mapa testadas', 'success');
                
                // Remover marcador ap√≥s 3 segundos
                setTimeout(() => {
                    testMap.removeLayer(testMarker);
                    log('üóëÔ∏è Marcador de teste removido', 'info');
                }, 3000);
                
            } catch (error) {
                log('‚ùå Erro ao testar funcionalidades: ' + error.message, 'error');
            }
        }
        
        function resetMap() {
            if (testMap) {
                testMap.remove();
                testMap = null;
                log('üîÑ Mapa resetado', 'info');
            }
            
            setTimeout(() => {
                testMapCreation();
            }, 500);
        }
        
        // Iniciar valida√ß√£o quando p√°gina carregar
        window.addEventListener('load', () => {
            log('üöÄ P√°gina carregada, iniciando valida√ß√£o em 1 segundo...', 'info');
            setTimeout(validateSystem, 1000);
        });
        
        // Atualizar contador de scripts carregados
        let scriptsLoaded = 0;
        const totalScripts = 4;
        
        function updateScriptsCounter() {
            scriptsLoaded++;
            document.getElementById('scriptsLoaded').textContent = `${scriptsLoaded}/${totalScripts}`;
        }
        
        // Simular carregamento de scripts (para demonstra√ß√£o)
        setInterval(() => {
            if (scriptsLoaded < totalScripts) {
                updateScriptsCounter();
            }
        }, 800);
    </script>
</body>
</html>
